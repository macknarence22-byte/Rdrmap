<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RP Map (Builder + Viewer)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#070910;
      --panel: rgba(14,16,22,.88);
      --stroke: rgba(255,255,255,.14);
      --text:#fff;
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.55);
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r: 16px;
      --r2: 12px;
      --ui: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      --accent:#7c3aed;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }

    html, body, #map { height: 100%; margin: 0; background: var(--bg); }

    /* Make the cursor very visible on top of the map */
    #map { cursor: crosshair; }
    .mouse-halo{
      position: fixed;
      width: 22px; height: 22px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.95);
      box-shadow: 0 0 0 4px rgba(124,58,237,.25), 0 8px 18px rgba(0,0,0,.55);
      pointer-events: none;
      transform: translate(-50%,-50%);
      z-index: 20000;
      mix-blend-mode: screen;
      display: none;
    }
    .mouse-halo.on { display:block; }

    /* Panels */
    .panel{
      position: fixed;
      z-index: 9999;
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      color: var(--text);
      font: 13px var(--ui);
      overflow: hidden;
    }

    .panel-header{
      padding: 12px 12px 10px;
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .title{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .title b{ font-size: 14px; letter-spacing:.2px; }
    .title span{ font-size: 11px; color: var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      font-weight: 900;
      font-size: 12px;
      user-select:none;
    }

    .panel-body{ padding: 12px; }
    .row{ display:flex; gap:8px; margin: 8px 0; }
    .col{ display:flex; flex-direction:column; gap:8px; }

    label.small{
      font-size: 11px; color: var(--muted2);
      font-weight: 900; letter-spacing:.2px; text-transform: uppercase;
    }

    select, input, button, textarea{
      width: 100%;
      box-sizing: border-box;
      padding: 10px 10px;
      border-radius: var(--r2);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font: 800 13px var(--ui);
      outline: none;
    }
    input[type="color"]{ padding: 0; height: 42px; border-radius: var(--r2); }
    button{ cursor: pointer; transition: 120ms ease; }
    button:hover{ background: rgba(255,255,255,.10); }
    button:disabled{ opacity: .5; cursor:not-allowed; }

    textarea{
      height: 130px;
      font: 11px var(--mono);
      font-weight: 650;
      background: rgba(0,0,0,.35);
    }

    .divider{ height:1px; background: var(--stroke); margin: 10px 0; }
    .hint{ color: var(--muted); font-size: 12px; line-height: 1.35; }

    /* Layout */
    #controlPanel{ top: 10px; left: 10px; width: 360px; max-width: calc(100vw - 24px); }
    #infoPanel{ top: 10px; right: 10px; width: 380px; max-width: calc(100vw - 24px); }

    /* Bottom bar (zoom/coords/editor) */
    #hudBar{
      position: fixed;
      left: 10px;
      bottom: 10px;
      z-index: 10000;
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      width: 520px;
      max-width: calc(100vw - 24px);
    }
    #hudLeft{ flex:1; display:flex; flex-direction:column; gap:2px; min-width:0; }
    #hudLeft b{ font-size: 13px; }
    #hudLeft span{ font-size: 11px; color: var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #hudRight{ display:flex; gap:8px; flex-shrink:0; }
    #hudRight button{ width:auto; padding: 10px 12px; }

    .chip{
      font: 900 11px var(--ui);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      padding: 4px 8px;
      color: rgba(255,255,255,.9);
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-right: 6px;
      user-select:none;
    }

    /* Info panel content */
    .info-empty{ color: var(--muted); font-size: 12px; padding: 8px 0; }
    .info-kv{ display:flex; gap:10px; align-items:flex-start; padding: 8px 0; border-bottom: 1px dashed rgba(255,255,255,.12); }
    .info-kv:last-child{ border-bottom: 0; }
    .info-kv b{
      width: 92px; color: var(--muted2);
      font-weight: 900; font-size: 11px; letter-spacing:.2px; text-transform: uppercase; flex-shrink:0;
    }
    .info-kv div{ flex:1; font: 650 12px var(--ui); color: var(--text); word-break: break-word; }
    .tag{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      font-weight: 900;
      font-size: 11px;
      margin-right: 6px;
      margin-bottom: 6px;
      color: rgba(255,255,255,.9);
    }

    /* Marker icons */
    .house-badge{
      width: 30px; height: 30px;
      border-radius: 999px;
      background: rgba(10,12,16,.92);
      color:#fff;
      display:grid;
      place-items:center;
      border: 2px solid #fff;
      box-shadow: 0 2px 14px rgba(0,0,0,.6);
      font: 900 14px/1 var(--ui);
      user-select:none;
    }
    .badge{
      width: 30px; height: 30px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      border: 2px solid rgba(255,255,255,.95);
      box-shadow: 0 2px 14px rgba(0,0,0,.6);
      font: 900 14px/1 var(--ui);
      user-select:none;
      background: rgba(10,12,16,.72);
    }

    /* Leaflet tweaks: make zoom smoother & controls nicer */
    .leaflet-control-zoom a{
      background: rgba(14,16,22,.92) !important;
      color: #fff !important;
      border: 1px solid rgba(255,255,255,.14) !important;
      width: 36px !important;
      height: 36px !important;
      line-height: 34px !important;
    }
    .leaflet-control-zoom { box-shadow: var(--shadow) !important; border-radius: 12px !important; overflow:hidden; }
    .leaflet-container{ outline:none; }
    .leaflet-popup-content{ margin: 12px 14px; }

    @media (max-width: 920px){
      #infoPanel{ top:auto; bottom: 90px; right: 10px; width: 360px; }
      #hudBar{ width: calc(100vw - 24px); }
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="mouse-halo" id="mouseHalo"></div>

  <!-- LEFT: Control Panel -->
  <aside class="panel" id="controlPanel">
    <div class="panel-header">
      <div class="title">
        <b>RP Map</b>
        <span id="mapSubtitle">Viewer mode ‚Ä¢ Click things to inspect</span>
      </div>
      <div class="pill" id="savePill">Saved</div>
    </div>

    <div class="panel-body">
      <div class="col">
        <div>
          <label class="small">Search</label>
          <input id="search" placeholder="Search houses, POIs, roads, counties..." />
        </div>

        <div class="row">
          <div style="flex:1">
            <label class="small">Mode</label>
            <select id="mode">
              <option value="inspect">Inspect (Viewer)</option>
              <option value="select" disabled>Select / Move (Editor)</option>
              <option value="marker" disabled>Place Marker (Editor)</option>
              <option value="road" disabled>Draw Road (Editor)</option>
              <option value="area" disabled>Draw Area / County (Editor)</option>
              <option value="erase" disabled>Erase (Editor)</option>
            </select>
          </div>
          <div style="width:120px">
            <label class="small">Color</label>
            <input id="color" type="color" value="#ffffff" />
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label class="small">Marker Type</label>
            <select id="markerType">
              <option value="house">House #</option>
              <option value="poi">POI</option>
              <option value="shop">Shop</option>
              <option value="sheriff">Sheriff</option>
              <option value="stable">Stable</option>
              <option value="camp">Camp</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div style="width:120px">
            <label class="small">House #</label>
            <input id="houseNumber" type="number" min="1" placeholder="Auto" />
          </div>
        </div>

        <div class="row">
          <button id="finishRoad" disabled>Finish Road</button>
          <button id="undoPoint" disabled>Undo Point</button>
        </div>

        <div class="row">
          <button id="finishArea" disabled>Finish Area</button>
          <button id="closeArea" disabled>Close Loop</button>
        </div>

        <div class="row">
          <button id="deleteSelected" disabled>Delete Selected</button>
          <button id="clearSelection" disabled>Clear Select</button>
        </div>

        <div class="row">
          <button id="resetView">Reset View</button>
          <button id="exportJson">Export</button>
        </div>

        <div class="row">
          <button id="importJson">Import</button>
          <button id="clearAll" disabled>Clear All (Editor)</button>
        </div>

        <div class="divider"></div>

        <label class="small">Import / Export Box</label>
        <textarea id="box" placeholder="Export JSON here or paste JSON to import..."></textarea>

        <div class="hint" style="margin-top:8px">
          Tips:
          <br>‚Ä¢ Mouse wheel / trackpad zoom is tuned smoother.
          <br>‚Ä¢ Cursor halo shows exactly where you‚Äôre pointing.
          <br>‚Ä¢ Later: Vercel autosave + Discord updates plug in cleanly.
        </div>
      </div>
    </div>
  </aside>

  <!-- RIGHT: Info Panel -->
  <aside class="panel" id="infoPanel">
    <div class="panel-header">
      <div class="title">
        <b>Info</b>
        <span id="infoSubtitle">Click something to view details</span>
      </div>
      <button id="closeInfo" style="width:auto; padding:8px 10px;">Close</button>
    </div>
    <div class="panel-body" id="infoBody">
      <div class="info-empty">Nothing selected yet.</div>
    </div>
  </aside>

  <!-- Bottom HUD (coords + zoom + editor lock + zoom buttons) -->
  <div id="hudBar">
    <div id="hudLeft">
      <b id="editTitle">Viewer Mode</b>
      <span id="hudLine">
        <span class="chip" id="chipXY">x: ‚Äî y: ‚Äî</span>
        <span class="chip" id="chipZoom">zoom: ‚Äî</span>
        <span class="chip" id="chipHint">Scroll to zoom ‚Ä¢ Drag to pan</span>
      </span>
    </div>
    <div id="hudRight">
      <button id="zoomOut">‚àí</button>
      <button id="zoomIn">+</button>
      <button id="btnSignIn">Sign in</button>
      <button id="btnSignOut" disabled>Sign out</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ====== CONFIG ======
    const MAP_W = 1536;
    const MAP_H = 1152;
    const MAP_IMAGE_URL = "./assets/rdo-map.jpeg";
    const STORAGE_KEY = "rp_map_builder_shell_v2";

    // ====== DATA MODEL ======
    // roads: { id, kind:'road'|'border', name, color, pts:[[y,x]...], meta:{} }
    // areas: { id, kind:'county'|'area', name, color, pts:[[y,x]...], meta:{} }
    // markers:{ id, kind:'house'|'poi'..., name, x,y,color, houseNumber?, meta:{} }
    let data = { markers: [], roads: [], areas: [], meta: { mapId: "default", updatedAt: null } };

    // ====== AUTH STUB ======
    let isEditor = false;

    // ====== MAP SETUP (smooth zoom) ======
    const map = L.map("map", {
      crs: L.CRS.Simple,
      minZoom: -3,
      maxZoom: 4,
      zoomSnap: 0.25,
      zoomDelta: 0.25,
      wheelPxPerZoomLevel: 90,   // smoother wheel zoom
      smoothWheelZoom: true,     // leaflet internal uses ease better in some builds
      smoothSensitivity: 1.2,
      inertia: true,
      inertiaDeceleration: 2500,
      zoomControl: true
    });

    const bounds = [[0,0],[MAP_H, MAP_W]];
    L.imageOverlay(MAP_IMAGE_URL, bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(L.latLngBounds(bounds).pad(0.25));

    // ====== LAYERS ======
    const layerHouses = L.layerGroup().addTo(map);
    const layerPois = L.layerGroup().addTo(map);
    const layerRoads = L.layerGroup().addTo(map);
    const layerBorders = L.layerGroup().addTo(map);
    const layerCounties = L.layerGroup().addTo(map);

    // ====== UI ======
    const modeSel = document.getElementById("mode");
    const markerTypeSel = document.getElementById("markerType");
    const houseNumberInp = document.getElementById("houseNumber");
    const colorInp = document.getElementById("color");
    const searchInp = document.getElementById("search");
    const box = document.getElementById("box");

    const savePill = document.getElementById("savePill");
    const mapSubtitle = document.getElementById("mapSubtitle");
    const infoBody = document.getElementById("infoBody");
    const infoSubtitle = document.getElementById("infoSubtitle");

    const btnSignIn = document.getElementById("btnSignIn");
    const btnSignOut = document.getElementById("btnSignOut");
    const editTitle = document.getElementById("editTitle");

    const chipXY = document.getElementById("chipXY");
    const chipZoom = document.getElementById("chipZoom");

    const zoomInBtn = document.getElementById("zoomIn");
    const zoomOutBtn = document.getElementById("zoomOut");

    const btnFinishRoad = document.getElementById("finishRoad");
    const btnUndoPoint = document.getElementById("undoPoint");
    const btnFinishArea = document.getElementById("finishArea");
    const btnCloseArea = document.getElementById("closeArea");
    const btnDeleteSelected = document.getElementById("deleteSelected");
    const btnClearSelection = document.getElementById("clearSelection");
    const btnClearAll = document.getElementById("clearAll");

    // ====== Cursor halo ======
    const halo = document.getElementById("mouseHalo");
    const mapEl = document.getElementById("map");
    mapEl.addEventListener("mouseenter", () => halo.classList.add("on"));
    mapEl.addEventListener("mouseleave", () => halo.classList.remove("on"));
    mapEl.addEventListener("mousemove", (e) => {
      halo.style.left = e.clientX + "px";
      halo.style.top = e.clientY + "px";
    });

    // ====== Helpers ======
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function setSaved(ok){
      savePill.textContent = ok ? "Saved" : "Saving...";
      savePill.style.opacity = ok ? "0.9" : "1";
    }
    function saveLocal(){
      try{
        data.meta.updatedAt = new Date().toISOString();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        setSaved(true);
      }catch{}
    }
    function loadLocal(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object") return;
        if (!Array.isArray(parsed.markers) || !Array.isArray(parsed.roads) || !Array.isArray(parsed.areas)) return;
        data = parsed;
      }catch{}
    }
    function nextHouseNumber(){
      const nums = data.markers.filter(m=>m.kind==="house").map(m=>m.houseNumber||0);
      let n = 1;
      while (nums.includes(n)) n++;
      return n;
    }
    function newId(prefix){
      return `${prefix}-${Math.random().toString(16).slice(2,8)}-${Date.now().toString(16).slice(-4)}`;
    }

    function setEditorMode(on){
      isEditor = on;
      for (const opt of modeSel.options){
        const editorOnly = ["select","marker","road","area","erase"];
        opt.disabled = editorOnly.includes(opt.value) ? !isEditor : false;
      }
      if (!isEditor) modeSel.value = "inspect";

      btnFinishRoad.disabled = !isEditor;
      btnUndoPoint.disabled = !isEditor;
      btnFinishArea.disabled = !isEditor;
      btnCloseArea.disabled = !isEditor;
      btnDeleteSelected.disabled = !isEditor;
      btnClearSelection.disabled = !isEditor;
      btnClearAll.disabled = !isEditor;

      btnSignIn.disabled = isEditor;
      btnSignOut.disabled = !isEditor;

      editTitle.textContent = isEditor ? "Editor Mode" : "Viewer Mode";
      mapSubtitle.textContent = isEditor
        ? "Editor mode ‚Ä¢ Create markers, roads, borders, counties"
        : "Viewer mode ‚Ä¢ Click things to inspect";
    }

    function iconForMarker(m){
      const color = m.color || "#ffffff";
      if (m.kind === "house"){
        const num = m.houseNumber ?? 1;
        return L.divIcon({
          className:"",
          html:`<div class="house-badge" style="border-color:${color}">${escapeHtml(num)}</div>`,
          iconSize:[30,30],
          iconAnchor:[15,15]
        });
      }
      const glyph =
        m.kind === "poi" ? "üìç" :
        m.kind === "shop" ? "üõí" :
        m.kind === "sheriff" ? "‚òÖ" :
        m.kind === "stable" ? "üêé" :
        m.kind === "camp" ? "‚õ∫" :
        "‚Ä¢";

      return L.divIcon({
        className:"",
        html:`<div class="badge" style="border-color:${color}; color:${color}">${glyph}</div>`,
        iconSize:[30,30],
        iconAnchor:[15,15]
      });
    }

    function openInfo(obj){
      const tags = [];
      if (obj.kind) tags.push(obj.kind);
      const meta = obj.meta && typeof obj.meta === "object" ? obj.meta : {};

      infoSubtitle.textContent = obj.kind ? `${obj.kind.toUpperCase()} ‚Ä¢ ${obj.id}` : "Selected";
      infoBody.innerHTML = `
        ${tags.length ? `<div style="margin-bottom:8px">${tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}</div>` : ""}

        <div class="info-kv"><b>Name</b><div>${escapeHtml(obj.name || "(unnamed)")}</div></div>
        <div class="info-kv"><b>Color</b><div>${escapeHtml(obj.color || "#ffffff")}</div></div>

        ${obj.kind === "house" ? `<div class="info-kv"><b>House #</b><div>${escapeHtml(obj.houseNumber ?? "")}</div></div>` : ""}

        ${(obj.x != null && obj.y != null) ? `<div class="info-kv"><b>Coords</b><div>x:${escapeHtml(obj.x)} y:${escapeHtml(obj.y)}</div></div>` : ""}

        ${obj.pts ? `<div class="info-kv"><b>Points</b><div>${escapeHtml(obj.pts.length)}</div></div>` : ""}

        <div class="info-kv"><b>Description</b><div>${escapeHtml(meta.description || "")}</div></div>
        <div class="info-kv"><b>Notes</b><div>${escapeHtml(meta.notes || "")}</div></div>

        <div class="info-kv"><b>Raw Meta</b><div><pre style="margin:0; white-space:pre-wrap; font:11px var(--mono); color:rgba(255,255,255,.85)">${escapeHtml(JSON.stringify(meta, null, 2))}</pre></div></div>
      `;
    }

    // ====== Selection & drawing state ======
    let selected = null; // { type:'marker'|'road'|'area', id, layer, obj }
    let drawPts = [];
    let drawPreview = null;

    function clearSelection(){
      selected = null;
      infoSubtitle.textContent = "Click something to view details";
      infoBody.innerHTML = `<div class="info-empty">Nothing selected yet.</div>`;
    }

    function render(){
      layerHouses.clearLayers();
      layerPois.clearLayers();
      layerRoads.clearLayers();
      layerBorders.clearLayers();
      layerCounties.clearLayers();

      // Areas
      for (const a of data.areas){
        const poly = L.polygon(a.pts || [], {
          color: a.color || "#ffffff",
          weight: 3,
          opacity: 0.95,
          fillOpacity: 0.12
        }).addTo(layerCounties);

        poly.on("click", (e) => {
          L.DomEvent.stopPropagation(e);
          selected = { type:"area", id:a.id, layer: poly, obj: a };
          openInfo(a);
        });
      }

      // Roads/Borders
      for (const r of data.roads){
        const line = L.polyline(r.pts || [], {
          color: r.color || "#ffffff",
          weight: (r.kind === "border" ? 5 : 4),
          opacity: 0.95,
          dashArray: (r.kind === "border" ? "10 6" : null)
        }).addTo(r.kind === "border" ? layerBorders : layerRoads);

        line.on("click", (e) => {
          L.DomEvent.stopPropagation(e);
          selected = { type:"road", id:r.id, layer: line, obj: r };
          openInfo(r);
        });
      }

      // Markers
      for (const m of data.markers){
        const marker = L.marker([m.y, m.x], {
          icon: iconForMarker(m),
          draggable: isEditor && (modeSel.value === "select")
        }).addTo(m.kind === "house" ? layerHouses : layerPois);

        marker.on("click", (e) => {
          L.DomEvent.stopPropagation(e);
          selected = { type:"marker", id:m.id, layer: marker, obj: m };
          openInfo(m);
        });

        marker.on("dragend", () => {
          if (!isEditor) return;
          const p = marker.getLatLng();
          m.y = Math.round(p.lat);
          m.x = Math.round(p.lng);
          setSaved(false);
          saveLocal();
          render();
        });
      }
    }

    // ====== HUD coords + zoom ======
    function updateHudFromEvent(e){
      if (!e?.latlng) return;
      const x = Math.round(e.latlng.lng);
      const y = Math.round(e.latlng.lat);
      chipXY.textContent = `x:${x} y:${y}`;
    }
    map.on("mousemove", updateHudFromEvent);
    map.on("zoomend", () => chipZoom.textContent = `zoom:${map.getZoom().toFixed(2)}`);
    chipZoom.textContent = `zoom:${map.getZoom().toFixed(2)}`;

    // ====== Better zoom buttons ======
    zoomInBtn.onclick = () => map.zoomIn(0.5);
    zoomOutBtn.onclick = () => map.zoomOut(0.5);

    document.getElementById("resetView").onclick = () => map.fitBounds(bounds);

    // ====== Export / Import ======
    document.getElementById("exportJson").onclick = () => {
      box.value = JSON.stringify(data, null, 2);
    };
    document.getElementById("importJson").onclick = () => {
      try{
        const parsed = JSON.parse(box.value);
        if (!parsed || typeof parsed !== "object") throw new Error("Invalid JSON");
        if (!Array.isArray(parsed.markers) || !Array.isArray(parsed.roads) || !Array.isArray(parsed.areas)) {
          throw new Error("JSON must have {markers:[], roads:[], areas:[]}");
        }
        data = parsed;
        setSaved(false);
        saveLocal();
        render();
        alert("Imported!");
      }catch(e){
        alert("Import failed: " + (e?.message || e));
      }
    };

    // ====== Sign-in (temporary, client-side) ======
    btnSignIn.onclick = () => {
      const code = prompt("Editor passcode (temporary):");
      if (code === "1234") {
        setEditorMode(true);
        render();
      } else {
        alert("Wrong code.");
      }
    };
    btnSignOut.onclick = () => {
      setEditorMode(false);
      render();
    };

    // ====== MODE LOGIC (simple but usable) ======
    function clearDrawPreview(){
      drawPts = [];
      if (drawPreview) { map.removeLayer(drawPreview); drawPreview = null; }
    }

    modeSel.addEventListener("change", () => {
      clearDrawPreview();
      render();
      clearSelection();
    });

    map.on("click", (e) => {
      const mode = modeSel.value;
      const x = Math.round(e.latlng.lng);
      const y = Math.round(e.latlng.lat);

      if (mode === "inspect") { clearSelection(); return; }
      if (!isEditor) return;

      // Place marker
      if (mode === "marker") {
        const kind = markerTypeSel.value;
        const color = colorInp.value || "#ffffff";
        const name = (prompt("Name (optional):", "") || "").trim();
        const notes = (prompt("Notes (optional):", "") || "").trim();

        let houseNumber = null;
        if (kind === "house") {
          const forced = parseInt(houseNumberInp.value, 10);
          houseNumber = Number.isFinite(forced) && forced > 0 ? forced : nextHouseNumber();
        }

        data.markers.push({
          id: newId(kind),
          kind,
          name: name || (kind === "house" ? `House #${houseNumber}` : kind.toUpperCase()),
          x, y, color,
          ...(kind === "house" ? { houseNumber } : {}),
          meta: { notes }
        });

        setSaved(false);
        saveLocal();
        render();
        return;
      }

      // Draw road or area (point-to-point)
      if (mode === "road" || mode === "area") {
        drawPts.push([y, x]);
        if (drawPreview) map.removeLayer(drawPreview);

        if (mode === "road") {
          drawPreview = L.polyline(drawPts, { weight: 4, opacity: 0.95, color: colorInp.value || "#fff" }).addTo(map);
        } else {
          drawPreview = L.polygon(drawPts, { weight: 3, opacity: 0.95, color: colorInp.value || "#fff", fillOpacity: 0.10 }).addTo(map);
        }
        setSaved(false);
        return;
      }

      // Erase (click something -> handled by layer click); clicking empty clears
      if (mode === "erase") { clearSelection(); return; }
    });

    btnUndoPoint.onclick = () => {
      if (!isEditor) return;
      if (!drawPts.length) return;
      drawPts.pop();
      if (drawPreview) map.removeLayer(drawPreview);
      drawPreview = null;
      if (!drawPts.length) return;

      if (modeSel.value === "road") {
        drawPreview = L.polyline(drawPts, { weight: 4, opacity: 0.95, color: colorInp.value || "#fff" }).addTo(map);
      } else if (modeSel.value === "area") {
        drawPreview = L.polygon(drawPts, { weight: 3, opacity: 0.95, color: colorInp.value || "#fff", fillOpacity: 0.10 }).addTo(map);
      }
    };

    btnFinishRoad.onclick = () => {
      if (!isEditor) return;
      if (modeSel.value !== "road") return alert('Switch to "Draw Road" mode.');
      if (drawPts.length < 2) return alert("Add at least 2 points.");
      const name = (prompt("Road name (optional):", "") || "").trim();
      const notes = (prompt("Notes (optional):", "") || "").trim();

      data.roads.push({
        id: newId("road"),
        kind: "road",
        name: name || "Road",
        color: colorInp.value || "#ffffff",
        pts: drawPts.slice(),
        meta: { notes }
      });

      clearDrawPreview();
      setSaved(false);
      saveLocal();
      render();
    };

    btnCloseArea.onclick = () => {
      if (!isEditor) return;
      if (modeSel.value !== "area") return alert('Switch to "Draw Area" mode.');
      if (drawPts.length < 3) return alert("Need at least 3 points.");
      // Leaflet polygon auto-closes visually, but this helps your intent (no-op data-wise)
      alert("Loop will be closed when you finish the area.");
    };

    btnFinishArea.onclick = () => {
      if (!isEditor) return;
      if (modeSel.value !== "area") return alert('Switch to "Draw Area" mode.');
      if (drawPts.length < 3) return alert("Add at least 3 points.");
      const name = (prompt("County/Area name (optional):", "") || "").trim();
      const notes = (prompt("Notes / rules (optional):", "") || "").trim();

      data.areas.push({
        id: newId("county"),
        kind: "county",
        name: name || "County",
        color: colorInp.value || "#ffffff",
        pts: drawPts.slice(),
        meta: { notes }
      });

      clearDrawPreview();
      setSaved(false);
      saveLocal();
      render();
    };

    btnDeleteSelected.onclick = () => {
      if (!isEditor) return;
      if (!selected) return;

      if (selected.type === "marker") data.markers = data.markers.filter(m => m.id !== selected.id);
      if (selected.type === "road") data.roads = data.roads.filter(r => r.id !== selected.id);
      if (selected.type === "area") data.areas = data.areas.filter(a => a.id !== selected.id);

      selected = null;
      clearSelection();
      setSaved(false);
      saveLocal();
      render();
    };

    btnClearSelection.onclick = () => clearSelection();

    btnClearAll.onclick = () => {
      if (!isEditor) return;
      if (!confirm("Clear EVERYTHING?")) return;
      data = { markers: [], roads: [], areas: [], meta: { mapId: data?.meta?.mapId || "default", updatedAt: null } };
      setSaved(false);
      saveLocal();
      clearSelection();
      render();
    };

    // Search (simple)
    searchInp.addEventListener("input", () => {
      const q = searchInp.value.trim().toLowerCase();
      render();
      if (!q) return;

      function fadeLayer(layer){
        layer.eachLayer(l => {
          const el = l.getElement?.();
          if (!el) return;
          // rough match: check popup/info based on stored selection by proximity is hard; keep simple:
          // just fade everything a little if searching; later we‚Äôll build a proper index.
          el.style.opacity = "0.25";
        });
      }
      fadeLayer(layerHouses);
      fadeLayer(layerPois);

      // brighten only markers with matching names
      [...data.markers].forEach(m => {
        const hit = (m.name||"").toLowerCase().includes(q) || (m.kind||"").toLowerCase().includes(q);
        if (!hit) return;
        // find marker by coords and set opacity
        const targetLayer = (m.kind==="house") ? layerHouses : layerPois;
        targetLayer.eachLayer(l => {
          const p = l.getLatLng?.();
          if (!p) return;
          if (Math.round(p.lng)===m.x && Math.round(p.lat)===m.y) {
            const el = l.getElement?.();
            if (el) el.style.opacity = "1";
          }
        });
      });
    });

    document.getElementById("closeInfo").onclick = () => {
      // just clear selection; panel stays, but content resets
      clearSelection();
    };

    // ====== Boot ======
    loadLocal();

    // If empty, add a tiny seed so it doesn't feel dead
    if (data.markers.length === 0 && data.roads.length === 0 && data.areas.length === 0) {
      data.markers.push(
        { id:"house-seed", kind:"house", houseNumber: 1, name:"House #1", x: 840, y: 620, color:"#ffffff", meta:{ notes:"Seed marker" } },
        { id:"poi-seed", kind:"poi", name:"Valentine", x: 790, y: 430, color:"#22c55e", meta:{ notes:"Seed POI" } }
      );
      data.roads.push(
        { id:"road-seed", kind:"road", name:"Main Road", color:"#f59e0b", pts:[[420,780],[520,820],[620,840]], meta:{ notes:"Seed road" } }
      );
      data.areas.push(
        { id:"county-seed", kind:"county", name:"Example County", color:"#3b82f6", pts:[[380,620],[360,740],[450,820],[520,700]], meta:{ notes:"Seed county" } }
      );
      saveLocal();
    }

    setEditorMode(false);
    render();
    setSaved(true);
    chipZoom.textContent = `zoom:${map.getZoom().toFixed(2)}`;
  </script>
</body>
</html>
