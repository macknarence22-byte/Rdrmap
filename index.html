<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RP Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/style.css?v=1"/>
</head>
<body>

  <div id="mapWrap">
    <img id="mapImg" src="/assets/map.jpg" alt="Map"/>
  </div>

  <button id="authBtn">ğŸ”’ Login</button>
  <button id="saveBtn" style="display:none;">ğŸ’¾ Save</button>

  <pre id="status"></pre>

<script>
const statusEl = document.getElementById("status");
const authBtn = document.getElementById("authBtn");
const saveBtn = document.getElementById("saveBtn");

let ME = null;
let MAP_ID = "rdo_main";
let DATA = { markers:[], roads:[], areas:[] };

function setStatus(x){ statusEl.textContent = x; }

async function refreshMe(){
  const r = await fetch("/api/me", { credentials:"include" });
  ME = await r.json();
  if(ME.loggedIn){
    authBtn.textContent = ME.editor ? "ğŸšª Logout (Editor)" : "ğŸšª Logout (Viewer)";
    authBtn.onclick = ()=> location.href="/api/logout";
    saveBtn.style.display = ME.editor ? "block" : "none";
  }else{
    authBtn.textContent = "ğŸ”’ Login";
    authBtn.onclick = ()=> location.href="/api/login";
    saveBtn.style.display = "none";
  }
}

async function loadMap(){
  const r = await fetch(`/api/load?mapId=${encodeURIComponent(MAP_ID)}`, { credentials:"include" });
  const j = await r.json();
  DATA = j.payload || DATA;
  setStatus("Loaded map: " + MAP_ID + "\n" + JSON.stringify(DATA,null,2));
}

async function saveMap(){
  if(!ME?.editor) return alert("Not allowed.");
  const r = await fetch("/api/save",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    credentials:"include",
    body: JSON.stringify({ mapId: MAP_ID, payload: DATA, message: "Manual save" })
  });
  const j = await r.json();
  if(!j.ok) return alert("Save failed: " + (j.error || "unknown"));
  alert(j.skipped ? "No changes to commit." : ("Saved! Commit: " + (j.commit||"ok")));
}

saveBtn.onclick = saveMap;

(async ()=>{
  await refreshMe();
  await loadMap();
})();
</script>

</body>
</html>